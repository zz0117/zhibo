<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢„è§ˆå…¨éƒ¨æ¨¡å¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #000;
            color: #fff;
            overflow-x: hidden;
        }
        
        .container {
            width: 100%;
            min-height: 100vh;
            position: relative;
        }
        
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }
        
        .platform-name {
            font-size: 18px;
            font-weight: bold;
        }
        
        .close-button {
            background-color: transparent;
            color: #fff;
            border: 1px solid #fff;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .close-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .video-grid {
            margin-top: 60px;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            grid-gap: 10px;
            overflow-y: auto;
        }
        
        .video-item {
            position: relative;
            background-color: #111;
            border-radius: 6px;
            overflow: hidden;
            aspect-ratio: 9/16;
            min-height: 250px;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* è§†é¢‘å ä½ç¬¦æ ·å¼ */
        .video-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #222;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 12px;
            z-index: 1;
        }
        
        .video-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
            padding: 10px;
        }
        
        .anchor-name {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .video-link {
            font-size: 12px;
            color: #ccc;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: block;
        }
        
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 20;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #00a8ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loading-text {
            margin-top: 10px;
            font-size: 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #ff0050;
            z-index: 20;
        }
        
        .refresh-button {
            margin-top: 10px;
            padding: 8px 16px;
            background-color: #00a8ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .refresh-button:hover {
            background-color: #0088cc;
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .video-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                padding: 8px;
                grid-gap: 8px;
            }
            
            .video-item {
                min-height: 200px;
            }
        }
    </style>
    <!-- å¼•å…¥flv.jsåº“ - æœ¬åœ°æ–‡ä»¶ -->
    <script src="./flv.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
        <div class="top-bar">
            <button class="close-button" onclick="window.close()">å…³é—­</button>
            <div class="platform-name" id="platformName">é¢„è§ˆå…¨éƒ¨æ¨¡å¼</div>
        </div>
        
        <!-- è§†é¢‘ç½‘æ ¼å®¹å™¨ -->
        <div class="video-grid" id="videoGrid"></div>
        
        <!-- åŠ è½½çŠ¶æ€ -->
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <div class="loading-text">åŠ è½½ä¸­...</div>
        </div>
        
        <!-- é”™è¯¯æç¤º -->
        <div class="error" id="error" style="display: none;">
            <p id="errorMessage">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</p>
            <button class="refresh-button" onclick="fetchAnchorData()">é‡è¯•</button>
        </div>
    </div>
    
    <script>
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // è·å–URLå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            window.platformAddress = decodeURIComponent(urlParams.get('address') || '');
            window.platformTitle = decodeURIComponent(urlParams.get('title') || 'é¢„è§ˆå…¨éƒ¨æ¨¡å¼');
            
            // è®¾ç½®å¹³å°åç§°
            document.getElementById('platformName').textContent = window.platformTitle;
            
            // åˆå§‹åŒ–å˜é‡
            window.anchorList = [];
            window.videoPlayers = {};
            window.userInteracted = false;
            window.videoObserver = null;
            
            // åˆå§‹åŒ–Intersection Observerç”¨äºæ‡’åŠ è½½
            initVideoObserver();
            
            // åŠ è½½ä¸»æ’­æ•°æ®
            fetchAnchorData();
            
            // æ˜¾ç¤ºç”¨æˆ·äº¤äº’æç¤º
            const interactionHint = document.getElementById('interactionHint');
            if (!interactionHint) {
                // åˆ›å»ºå…¨å±é®ç½©å®¹å™¨
                const overlay = document.createElement('div');
                overlay.id = 'interactionHint';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.9);
                    z-index: 1000;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    cursor: pointer;
                `;
                
                // åˆ›å»ºæç¤ºå†…å®¹
                const content = document.createElement('div');
                content.style.cssText = `
                    color: white;
                    text-align: center;
                    animation: pulse 2s infinite;
                `;
                content.innerHTML = `
                    <div style="font-size: 64px; margin-bottom: 20px;">ğŸ‘†</div>
                    <div style="font-size: 24px; margin-bottom: 10px;">è¯·ç‚¹å‡»é¡µé¢ä»»æ„ä½ç½®å¼€å§‹åŠ è½½è§†é¢‘</div>
                    <div style="font-size: 16px; opacity: 0.8;">ç‚¹å‡»åå°†å¼€å§‹æ’­æ”¾å¯è§†åŒºåŸŸå†…çš„è§†é¢‘</div>
                `;
                
                overlay.appendChild(content);
                    document.body.appendChild(overlay);
                // æ·»åŠ è„‰å†²åŠ¨ç”»
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes pulse {
                        0% { opacity: 1; }
                        50% { opacity: 0.7; }
                        100% { opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            } else {
                interactionHint.style.display = 'block';
            }
            
            // ç›‘å¬é¡µé¢ç‚¹å‡»äº‹ä»¶ï¼Œæ ‡è®°ç”¨æˆ·äº¤äº’çŠ¶æ€
            document.addEventListener('click', function() {
                if (!window.userInteracted) {
                    window.userInteracted = true;
                    console.log('ç”¨æˆ·å·²äº¤äº’ï¼Œå¯ä»¥è‡ªåŠ¨æ’­æ”¾è§†é¢‘');
                    // è§¦å‘å¯è§†åŒºåŸŸå†…è§†é¢‘çš„æ‡’åŠ è½½
                    triggerVisibleVideos();
                    // éšè—äº¤äº’æç¤º
                    const interactionHint = document.getElementById('interactionHint');
                    if (interactionHint) {
                        interactionHint.style.display = 'none';
                    }
                }
            }, { once: true });
            
            // ç›‘å¬æ»šåŠ¨äº‹ä»¶ï¼Œä¼˜åŒ–æ€§èƒ½å’Œèµ„æºä½¿ç”¨
            let scrollTimer = null;
            window.addEventListener('scroll', function() {
                if (window.userInteracted) {
                    // æ»šåŠ¨å¼€å§‹æ—¶ç«‹å³æš‚åœæ‰€æœ‰è§†é¢‘ï¼ŒèŠ‚çœèµ„æº
                    if (typeof pauseAllVideos === 'function') {
                        pauseAllVideos();
                    }
                    
                    // é˜²æŠ–å¤„ç†ï¼Œé¿å…é¢‘ç¹è®¡ç®—
                    clearTimeout(scrollTimer);
                    scrollTimer = setTimeout(function() {
                        // æ»šåŠ¨åœæ­¢ååªæ’­æ”¾å¯è§†åŒºåŸŸå†…çš„è§†é¢‘
                        triggerVisibleVideos();
                    }, 150);
                }
            });
        });
        
        // åˆå§‹åŒ–è§†é¢‘æ‡’åŠ è½½è§‚å¯Ÿå™¨
        function initVideoObserver() {
            // å…ˆç¡®ä¿pauseAllVideoså‡½æ•°å­˜åœ¨
            if (typeof pauseAllVideos !== 'function') {
                window.pauseAllVideos = function() {
                    Object.keys(window.videoPlayers).forEach(function(index) {
                        const playerInfo = window.videoPlayers[index];
                        if (playerInfo && playerInfo.player) {
                            try {
                                if (playerInfo.player.pause) {
                                    playerInfo.player.pause();
                                    playerInfo.playing = false;
                                    // å¯¹äºåŸç”Ÿvideoå…ƒç´ ï¼Œè¿›ä¸€æ­¥å‡å°‘èµ„æºå ç”¨
                                    if (playerInfo.player instanceof HTMLVideoElement) {
                                        playerInfo.player.volume = 0;
                                    }
                                }
                            } catch (e) {
                                console.error(`æš‚åœè§†é¢‘ ${index} å¤±è´¥:`, e);
                            }
                        }
                    });
                };
            }
            
            if ('IntersectionObserver' in window) {
                window.videoObserver = new IntersectionObserver(function(entries, observer) {
                    // åªå…³æ³¨å¯è§†åŒºåŸŸå†…çš„è§†é¢‘
                    entries.forEach(function(entry) {
                        const videoItem = entry.target;
                        const index = parseInt(videoItem.id.replace('video-item-', ''));
                        
                        if (index >= 0 && index < window.anchorList.length) {
                            if (entry.isIntersecting) {
                                // è§†é¢‘è¿›å…¥å¯è§†åŒºåŸŸ
                                if (window.userInteracted) {
                                    if (!window.videoPlayers[index]) {
                                        console.log(`è§†é¢‘ ${index} è¿›å…¥å¯è§†åŒºåŸŸï¼Œå¼€å§‹åŠ è½½`);
                                        initVideoPlayer(index, window.anchorList[index].address);
                                    } else {
                                        playVideo(index);
                                    }
                                }
                            } else {
                                // è§†é¢‘ç¦»å¼€å¯è§†åŒºåŸŸï¼Œç«‹å³åœæ­¢æ’­æ”¾
                                if (window.videoPlayers[index]) {
                                    console.log(`è§†é¢‘ ${index} ç¦»å¼€å¯è§†åŒºåŸŸï¼Œåœæ­¢æ’­æ”¾`);
                                    pauseVideo(index);
                                }
                            }
                        }
                    });
                }, {
                    rootMargin: '20px', // ç¼©å°é¢„åŠ è½½åŒºåŸŸ
                    threshold: 0.3      // æé«˜è§¦å‘é˜ˆå€¼ï¼Œç¡®ä¿è§†é¢‘ç¡®å®åœ¨å¯è§†åŒºåŸŸ
                });
            } else {
                // é™çº§å¤„ç†ï¼šä¸æ”¯æŒIntersectionObserverçš„æµè§ˆå™¨
                console.warn('æµè§ˆå™¨ä¸æ”¯æŒIntersectionObserverï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ');
            }
        }
        
        // è§¦å‘å¯è§†åŒºåŸŸå†…è§†é¢‘çš„æ‡’åŠ è½½
        function triggerVisibleVideos() {
            // å…ˆæš‚åœæ‰€æœ‰è§†é¢‘ï¼Œç¡®ä¿åªæœ‰å¯è§†åŒºåŸŸå†…çš„è§†é¢‘åœ¨æ’­æ”¾
            if (typeof pauseAllVideos === 'function') {
                pauseAllVideos();
            }
            
            if (window.videoObserver) {
                // é‡æ–°è§‚å¯Ÿæ‰€æœ‰è§†é¢‘å…ƒç´ 
                document.querySelectorAll('.video-item').forEach(function(videoItem) {
                    try {
                        window.videoObserver.unobserve(videoItem);
                    } catch (e) {
                        // å¿½ç•¥æœªè¢«è§‚å¯Ÿçš„å…ƒç´ é”™è¯¯
                    }
                    window.videoObserver.observe(videoItem);
                });
            } else {
                // é™çº§æ–¹æ¡ˆï¼šæ£€æŸ¥å¯è§†åŒºåŸŸå†…çš„è§†é¢‘
                console.log('é™çº§æ–¹æ¡ˆï¼šæ£€æŸ¥å¯è§†åŒºåŸŸå†…çš„è§†é¢‘');
                const windowHeight = window.innerHeight || document.documentElement.clientHeight;
                const videoItems = document.querySelectorAll('.video-item');
                
                videoItems.forEach(function(item, index) {
                    if (index >= 0 && index < window.anchorList.length) {
                        const rect = item.getBoundingClientRect();
                        // ä¸¥æ ¼åˆ¤æ–­å¯è§†åŒºåŸŸ
                        const isVisible = rect.top < windowHeight && rect.bottom > 0;
                        
                        if (isVisible && window.userInteracted) {
                            if (!window.videoPlayers[index]) {
                                initVideoPlayer(index, window.anchorList[index].address);
                            } else {
                                playVideo(index);
                            }
                        }
                    }
                });
            }
        }
        
        // è·å–ä¸»æ’­æ•°æ®
        function fetchAnchorData() {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('error').style.display = 'none';
            
            // è·å–URLä¸­çš„addresså‚æ•°ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼
            const urlParams = new URLSearchParams(window.location.search);
            let addressParam = urlParams.get('address') || 'jsonmitao.txt';
            
            console.log(`å‡†å¤‡è·å–ä¸»æ’­æ•°æ®ï¼Œåœ°å€å‚æ•°: ${addressParam}`);
            
            // å¤„ç†åœ°å€å‚æ•°ï¼Œé¿å…é‡å¤æ·»åŠ mf/å‰ç¼€
            let normalizedAddress = addressParam;
            if (addressParam.startsWith('mf/')) {
                // å¦‚æœå·²ç»åŒ…å«mf/å‰ç¼€ï¼Œåˆ™ç§»é™¤
                normalizedAddress = addressParam.substring(3);
            }
            
            // å‘é€è¯·æ±‚è·å–æ•°æ® - ä½¿ç”¨ç›¸å¯¹è·¯å¾„
            fetch(`/api_proxy/mf/${encodeURIComponent(normalizedAddress)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // éšè—åŠ è½½çŠ¶æ€
                    document.getElementById('loading').style.display = 'none';
                    
                    // ç›´æ¥ä½¿ç”¨APIè¿”å›çš„zhuboæ•°ç»„
                    window.anchorList = data.zhubo || [];
                    
                    // æ¸²æŸ“è§†é¢‘ç½‘æ ¼
                    renderVideoGrid();
                })
                .catch(error => {
                    console.error('è·å–ä¸»æ’­æ•°æ®å¤±è´¥:', error);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('errorMessage').textContent = `åŠ è½½å¤±è´¥: ${error.message}`;
                    document.getElementById('error').style.display = 'block';
                });
        }
        
        // æ¸²æŸ“è§†é¢‘ç½‘æ ¼
        function renderVideoGrid() {
            const videoGrid = document.getElementById('videoGrid');
            videoGrid.innerHTML = '';
            
            // æ˜¾ç¤ºæ‰€æœ‰è§†é¢‘ï¼Œä¸å†é™åˆ¶æ•°é‡
            window.anchorList.forEach((anchor, index) => {
                // åˆ›å»ºè§†é¢‘é¡¹å®¹å™¨
                const videoItem = document.createElement('div');
                videoItem.className = 'video-item';
                videoItem.id = `video-item-${index}`;
                
                // åˆ›å»ºè§†é¢‘å®¹å™¨
                const videoContainer = document.createElement('div');
                videoContainer.className = 'video-container';
                
                // åˆ›å»ºå ä½ç¬¦
                const placeholder = document.createElement('div');
                placeholder.className = 'video-placeholder';
                placeholder.textContent = 'åŠ è½½ä¸­...';
                
                // åˆ›å»ºè§†é¢‘å…ƒç´ 
                const videoElement = document.createElement('video');
                videoElement.id = `video-player-${index}`;
                videoElement.playsinline = true;
                videoElement.muted = true; // é»˜è®¤é™éŸ³ä»¥æé«˜åŠ è½½æ€§èƒ½
                videoElement.style.display = 'none'; // åˆå§‹éšè—
                
                // åˆ›å»ºè§†é¢‘ä¿¡æ¯
                const videoInfo = document.createElement('div');
                videoInfo.className = 'video-info';
                
                const anchorName = document.createElement('div');
                anchorName.className = 'anchor-name';
                anchorName.textContent = anchor.title || 'æœªçŸ¥ä¸»æ’­';
                
                const videoLink = document.createElement('a');
                videoLink.className = 'video-link';
                // æ„é€ è·³è½¬åˆ°video.htmlçš„é“¾æ¥ï¼Œæºå¸¦æ ‡é¢˜å’Œåœ°å€å‚æ•°
                const titleParam = encodeURIComponent(anchor.title || 'æœªçŸ¥ä¸»æ’­');
                const addressParam = encodeURIComponent(anchor.address || '');
                // è·å–å½“å‰é¡µé¢çš„å®Œæ•´URLï¼Œæ„å»ºå®Œæ•´çš„è·³è½¬è·¯å¾„
                const currentUrl = window.location.origin + window.location.pathname.replace(/\/[^\/]*$/, '/');
                videoLink.href = `${currentUrl}video.html?title=${titleParam}&address=${addressParam}`;
                console.log('é¢„è§ˆé¡µé¢è·³è½¬é“¾æ¥:', videoLink.href);
                videoLink.target = '_blank';
                videoLink.textContent = 'ç‚¹å‡»å…¨å±æ’­æ”¾';
                
                // ç»„è£…DOMå…ƒç´ 
                videoInfo.appendChild(anchorName);
                videoInfo.appendChild(videoLink);
                videoContainer.appendChild(placeholder);
                videoContainer.appendChild(videoElement);
                videoContainer.appendChild(videoInfo);
                videoItem.appendChild(videoContainer);
                videoGrid.appendChild(videoItem);
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œå…è®¸å•ç‹¬æ’­æ”¾/æš‚åœè¯¥è§†é¢‘
                videoContainer.addEventListener('click', function() {
                    // ç¡®ä¿ç”¨æˆ·äº¤äº’æ ‡è®°å·²è®¾ç½®
                    window.userInteracted = true;
                    
                    // å¦‚æœè§†é¢‘å°šæœªåˆå§‹åŒ–ï¼Œåˆ™åˆå§‹åŒ–
                    if (!window.videoPlayers[index]) {
                        initVideoPlayer(index, anchor.address);
                    } else {
                        toggleVideoPlay(index);
                    }
                });
                
                // ä½¿ç”¨Intersection Observerè§‚å¯Ÿè§†é¢‘å…ƒç´ 
                if (window.videoObserver) {
                    window.videoObserver.observe(videoItem);
                }
                
                // æ³¨æ„ï¼šä¸å†åœ¨è¿™é‡Œç«‹å³åˆå§‹åŒ–æ‰€æœ‰è§†é¢‘æ’­æ”¾å™¨
                // åªæœ‰å½“è§†é¢‘è¿›å…¥å¯è§†åŒºåŸŸå¹¶ä¸”ç”¨æˆ·å·²äº¤äº’æ—¶æ‰åˆå§‹åŒ–
            });
        }
        
        // åˆå§‹åŒ–è§†é¢‘æ’­æ”¾å™¨ï¼ˆæ‡’åŠ è½½ï¼‰
        function initVideoPlayer(index, videoUrl) {
            const videoElement = document.getElementById(`video-player-${index}`);
            
            // æ˜¾ç¤ºè§†é¢‘å…ƒç´ ï¼Œéšè—å ä½ç¬¦
            videoElement.style.display = 'block';
            const placeholder = document.querySelector(`#video-item-${index} .video-placeholder`);
            if (placeholder) {
                placeholder.style.display = 'none';
            }
            
            // å¦‚æœæ˜¯FLVæ ¼å¼ï¼Œä½¿ç”¨flv.js
            if (flvjs.isSupported() && videoUrl && (videoUrl.endsWith('.flv') || videoUrl.includes('flv'))) {
                try {
                    const flvPlayer = flvjs.createPlayer({
                        type: 'flv',
                        url: videoUrl
                    });
                    
                    flvPlayer.attachMediaElement(videoElement);
                    flvPlayer.load();
                    
                    // å­˜å‚¨æ’­æ”¾å™¨å®ä¾‹
                    window.videoPlayers[index] = {
                        type: 'flv',
                        player: flvPlayer,
                        loaded: true,
                        playing: false
                    };
                    
                    // ç”¨æˆ·äº¤äº’åå°è¯•æ’­æ”¾
                    if (window.userInteracted) {
                        playVideo(index);
                    }
                } catch (error) {
                    console.error(`åˆå§‹åŒ–FLVæ’­æ”¾å™¨å¤±è´¥ (${index}):`, error);
                    // é™çº§ä¸ºæ™®é€šè§†é¢‘
                    tryFallbackVideo(index, videoUrl);
                }
            } else {
                // æ™®é€šè§†é¢‘æ ¼å¼
                videoElement.src = videoUrl;
                
                // å­˜å‚¨æ’­æ”¾å™¨å®ä¾‹
                window.videoPlayers[index] = {
                    type: 'native',
                    player: videoElement,
                    loaded: true,
                    playing: false
                };
                
                // ç”¨æˆ·äº¤äº’åå°è¯•æ’­æ”¾
                if (window.userInteracted) {
                    playVideo(index);
                }
            }
        }
        
        // é™çº§åˆ°æ™®é€šè§†é¢‘æ’­æ”¾
        function tryFallbackVideo(index, videoUrl) {
            const videoElement = document.getElementById(`video-player-${index}`);
            videoElement.src = videoUrl;
            
            window.videoPlayers[index] = {
                type: 'native',
                player: videoElement,
                loaded: true,
                playing: false
            };
            
            if (window.userInteracted) {
                playVideo(index);
            }
        }
        
        // æ’­æ”¾æŒ‡å®šè§†é¢‘ - å¢å¼ºç‰ˆ
        function playVideo(index) {
            const playerInfo = window.videoPlayers[index];
            if (!playerInfo || !playerInfo.loaded) return;
            
            try {
                if (playerInfo.type === 'flv') {
                    playerInfo.player.play().then(() => {
                        playerInfo.playing = true;
                    }).catch(error => {
                        console.log(`è§†é¢‘ ${index} æ’­æ”¾å¤±è´¥:`, error);
                    });
                } else {
                    playerInfo.player.play().then(() => {
                        playerInfo.playing = true;
                    }).catch(error => {
                        console.log(`è§†é¢‘ ${index} æ’­æ”¾å¤±è´¥:`, error);
                    });
                }
                console.log(`æ­£åœ¨æ’­æ”¾è§†é¢‘ ${index}`);
            } catch (error) {
                console.error(`å°è¯•æ’­æ”¾è§†é¢‘ ${index} å‡ºé”™:`, error);
            }
        }
        
        // æš‚åœæŒ‡å®šè§†é¢‘ - å¢å¼ºç‰ˆï¼Œç¡®ä¿èµ„æºé‡Šæ”¾
        function pauseVideo(index) {
            const playerInfo = window.videoPlayers[index];
            if (!playerInfo || !playerInfo.loaded) return;
            
            try {
                if (playerInfo.type === 'flv') {
                    playerInfo.player.pause();
                    playerInfo.playing = false;
                } else {
                    playerInfo.player.pause();
                    playerInfo.playing = false;
                    // å¯¹äºåŸç”Ÿvideoå…ƒç´ ï¼Œè¿›ä¸€æ­¥å‡å°‘èµ„æºå ç”¨
                    if (playerInfo.player instanceof HTMLVideoElement) {
                        // é™ä½éŸ³é‡ä¸º0ä»¥é¿å…éŸ³é¢‘é—®é¢˜
                        playerInfo.player.volume = 0;
                    }
                }
                console.log(`å·²æš‚åœè§†é¢‘ ${index}`);
            } catch (error) {
                console.error(`å°è¯•æš‚åœè§†é¢‘ ${index} å‡ºé”™:`, error);
            }
        }
        
        // æš‚åœæ‰€æœ‰è§†é¢‘æ’­æ”¾
        function pauseAllVideos() {
            Object.keys(window.videoPlayers).forEach(function(index) {
                const player = window.videoPlayers[index];
                if (player) {
                    pauseVideo(parseInt(index));
                }
            });
        }
        
        // åˆ‡æ¢è§†é¢‘æ’­æ”¾çŠ¶æ€
        function toggleVideoPlay(index) {
            const playerInfo = window.videoPlayers[index];
            if (!playerInfo || !playerInfo.loaded) return;
            
            if (playerInfo.playing) {
                pauseVideo(index);
            } else {
                playVideo(index);
            }
        }
        
        // æ’­æ”¾æ‰€æœ‰è§†é¢‘ - ä¿®æ”¹ä¸ºåªæ’­æ”¾å¯è§†åŒºåŸŸå†…çš„è§†é¢‘
        function playAllVideos() {
            // å…ˆæš‚åœæ‰€æœ‰è§†é¢‘
            pauseAllVideos();
            
            // åªæ’­æ”¾å¯è§†åŒºåŸŸå†…çš„è§†é¢‘
            triggerVisibleVideos();
        }
        
        // æ¸…ç†èµ„æº
        window.addEventListener('beforeunload', function() {
            // æ¸…ç†æ‰€æœ‰flv.jsæ’­æ”¾å™¨å®ä¾‹
            for (let key in window.videoPlayers) {
                const playerInfo = window.videoPlayers[key];
                if (playerInfo.type === 'flv' && playerInfo.player) {
                    try {
                        playerInfo.player.destroy();
                    } catch (e) {
                        console.error(`é”€æ¯æ’­æ”¾å™¨ ${key} æ—¶å‡ºé”™:`, e);
                    }
                }
            }
            
            // æ¸…ç†è§‚å¯Ÿå™¨
            if (window.videoObserver) {
                document.querySelectorAll('.video-item').forEach(item => {
                    window.videoObserver.unobserve(item);
                });
            }
        });
    </script>
</body>
</html>